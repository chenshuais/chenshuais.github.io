<!DOCTYPE html>
<html data-color-mode="light" data-dark-theme="dark" data-light-theme="light" lang="zh-CN">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href="//cdn.staticfile.net/Primer/21.0.7/primer.css" rel="stylesheet" />
    <link rel="icon" href="https://ian2018.cn/favicon.png"><script>
        let theme = localStorage.getItem("meek_theme") || "light";
        document.documentElement.setAttribute("data-color-mode", theme);
    </script>
<meta name="description" content="`Gmeek-html<img src='https://blog-image.ian2018.cn/images/86ff272f7ad726ad95ce92b6d9bb8137b55e2ea1.png'>`

é€šè¿‡ä¹‹å‰çš„åˆ†äº«ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† Kotlin çš„åç¨‹æ˜¯ä»€ä¹ˆï¼Œä¹ŸçŸ¥é“äº†æŒ‚èµ·å‡½æ•°ã€‚">
<meta property="og:title" content="Kotlin åç¨‹ä¸­çš„ Job">
<meta property="og:description" content="`Gmeek-html<img src='https://blog-image.ian2018.cn/images/86ff272f7ad726ad95ce92b6d9bb8137b55e2ea1.png'>`

é€šè¿‡ä¹‹å‰çš„åˆ†äº«ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† Kotlin çš„åç¨‹æ˜¯ä»€ä¹ˆï¼Œä¹ŸçŸ¥é“äº†æŒ‚èµ·å‡½æ•°ã€‚">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.ian2018.club/post/Kotlin%20-xie-cheng-zhong-de-%20Job.html">
<meta property="og:image" content="https://blog-image.ian2018.cn/avatar.webp">
<title>Kotlin åç¨‹ä¸­çš„ Job</title>
<link href="//unpkg.com/@wooorm/starry-night@2.1.1/style/both.css" rel="stylesheet" />

</head>
<style>
body{box-sizing: border-box;min-width: 200px;max-width: 900px;margin: 20px auto;padding: 45px;font-size: 16px;font-family: sans-serif;line-height: 1.25;}
#header{display:flex;padding-bottom:8px;border-bottom: 1px solid var(--borderColor-muted, var(--color-border-muted));margin-bottom: 16px;}
#footer {margin-top:64px; text-align: center;font-size: small;}

</style>

<style>
.postTitle{margin: auto 0;font-size:40px;font-weight:bold;}
.title-right{display:flex;margin:auto 0 0 auto;}
.title-right .circle{padding: 14px 16px;margin-right:8px;}
#postBody{border-bottom: 1px solid var(--color-border-default);padding-bottom:36px;}
#postBody hr{height:2px;}
#cmButton{height:48px;margin-top:48px;}
#comments{margin-top:64px;}
.g-emoji{font-size:24px;}
@media (max-width: 600px) {
    body {padding: 8px;}
    .postTitle{font-size:24px;}
}
</style>
<style>#user-content-page_pv{color:red}#user-content-page_uv{color:red}</style>



<body>
    <div id="header">
<h1 class="postTitle">Kotlin åç¨‹ä¸­çš„ Job</h1>
<div class="title-right">
    <a href="https://blog.ian2018.club" id="buttonHome" class="btn btn-invisible circle" title="é¦–é¡µ">
        <svg class="octicon" width="16" height="16">
            <path id="pathHome" fill-rule="evenodd"></path>
        </svg>
    </a>
    

    <a class="btn btn-invisible circle" onclick="modeSwitch();" title="åˆ‡æ¢ä¸»é¢˜">
        <svg class="octicon" width="16" height="16" >
            <path id="themeSwitch" fill-rule="evenodd"></path>
        </svg>
    </a>

</div>
</div>
    <div id="content">
<div class="markdown-body" id="postBody"><p><img src="https://blog-image.ian2018.cn/images/86ff272f7ad726ad95ce92b6d9bb8137b55e2ea1.png"></p>
<p>é€šè¿‡ä¹‹å‰çš„åˆ†äº«ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† Kotlin çš„åç¨‹æ˜¯ä»€ä¹ˆï¼Œä¹ŸçŸ¥é“äº†æŒ‚èµ·å‡½æ•°ã€‚ä»Šå¤©å°±ä¸€å—æ¥å­¦ä¹ ä¸€ä¸‹ä»€ä¹ˆæ˜¯ <strong>Job</strong>ã€‚</p>
<h2>Job ä»å“ªæ¥</h2>
<p>å¹³æ—¶æˆ‘ä»¬ä½¿ç”¨åç¨‹ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯ç›´æ¥ <code class="notranslate">launch</code> ä¸€ä¸‹å°±å®Œäº†ï¼Œå¾ˆå°‘çš„æ—¶å€™ä¼šç”¨ä¸€ä¸‹ <code class="notranslate">async</code>ã€‚</p>
<div class="highlight highlight-source-kotlin"><pre class="notranslate">launch {
}
async { 
}</pre></div>
<p>å¦‚æœç”¨è¿‡ <code class="notranslate">async</code> çš„è¯ï¼Œä¼šå‘ç° IDE ä¼šæœ‰é»„è‰²çš„æé†’ï¼Œå‘Šè¯‰ä½ è¿”å›å€¼ <strong>Deferred</strong> æ²¡æœ‰ä½¿ç”¨ã€‚<br>
<img src="https://blog-image.ian2018.cn/images/cce0c7273f0b100ff9f5957cd51b7f5ae9386dc8.png"></p>
<p>è¿™ä¸ª <strong>Deferred</strong> å…¶å®å°±æ˜¯ <strong>Job</strong>ï¼Œå®ƒæ˜¯ä¸€ä¸ªç»§æ‰¿ <strong>Job</strong> çš„æ¥å£ã€‚<br>
<img src="https://blog-image.ian2018.cn/images/0f510aed293051cab6c231e17e9073fc6c46552c.png"></p>
<p>å…¶å®ä¸æ­¢ <code class="notranslate">async</code> æœ‰è¿”å›å€¼ï¼Œ<code class="notranslate">launch</code> ä¹Ÿæ˜¯æœ‰è¿”å›å€¼çš„ï¼Œè€Œ <code class="notranslate">launch</code> çš„è¿”å›å€¼ç›´æ¥å°±æ˜¯ä¸€ä¸ª <strong>Job</strong>ã€‚<br>
<img src="https://blog-image.ian2018.cn/images/4cff61b074c930a018498356a653c3262c27f8f1.png"></p>
<p>æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ <strong>Job</strong> çš„æºç çš„å®šä¹‰ï¼ˆè¿™é‡Œæˆ‘åˆ é™¤äº†ä¸€äº›æ³¨é‡Šå’Œå†…éƒ¨ APIï¼‰ï¼š</p>
<div class="highlight highlight-source-kotlin"><pre class="notranslate"><span class="pl-k">public</span> <span class="pl-k">interface</span> <span class="pl-en">Job</span> : <span class="pl-en">CoroutineContext</span>.<span class="pl-en">Element</span> {
    
    <span class="pl-c"><span class="pl-c">//</span> ------------ state query ------------</span>

    <span class="pl-k">public</span> <span class="pl-k">val</span> isActive<span class="pl-k">:</span> <span class="pl-c1">Boolean</span>

    <span class="pl-k">public</span> <span class="pl-k">val</span> isCompleted<span class="pl-k">:</span> <span class="pl-c1">Boolean</span>

    <span class="pl-k">public</span> <span class="pl-k">val</span> isCancelled<span class="pl-k">:</span> <span class="pl-c1">Boolean</span>

    <span class="pl-c"><span class="pl-c">//</span> ------------ state update ------------</span>

    <span class="pl-k">public</span> <span class="pl-k">fun</span> <span class="pl-en">start</span>(): <span class="pl-c1">Boolean</span>

    <span class="pl-k">public</span> <span class="pl-k">fun</span> <span class="pl-en">cancel</span>(<span class="pl-smi">cause</span><span class="pl-k">:</span> <span class="pl-en">CancellationException</span><span class="pl-k">?</span> = null)

    <span class="pl-c"><span class="pl-c">//</span> ------------ parent-child ------------</span>

    <span class="pl-k">public</span> <span class="pl-k">val</span> children<span class="pl-k">:</span> <span class="pl-en">Sequence</span>&lt;<span class="pl-en">Job</span>&gt;

    <span class="pl-c"><span class="pl-c">//</span> ------------ state waiting ------------</span>

    <span class="pl-k">public</span> <span class="pl-k">suspend</span> <span class="pl-k">fun</span> <span class="pl-en">join</span>()

    <span class="pl-c"><span class="pl-c">//</span> ------------ low-level state-notification ------------</span>

    <span class="pl-k">public</span> <span class="pl-k">fun</span> <span class="pl-en">invokeOnCompletion</span>(<span class="pl-smi">handler</span><span class="pl-k">:</span> <span class="pl-en">CompletionHandler</span>): <span class="pl-en">DisposableHandle</span>
    
}</pre></div>
<p><strong>Job</strong> çš„æºç æ³¨é‡Šè¿˜æ˜¯å†™çš„å¾ˆæ¸…æ¥šçš„ï¼Œè¿˜è´´å¿ƒçš„åšäº†åˆ’åˆ†ã€‚</p>
<p>ä»æºç çš„æ³¨é‡Šæˆ‘ä»¬å¯ä»¥å¤§æ¦‚çŸ¥é“ï¼Œ<strong>Job</strong> å¤§è‡´åˆ†äº†äº”ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>çŠ¶æ€çš„æŸ¥è¯¢</li>
<li>çŠ¶æ€çš„æ›´æ–°</li>
<li>çˆ¶å­å…³ç³»</li>
<li>çŠ¶æ€çš„ç­‰å¾…</li>
<li>çŠ¶æ€ç›‘å¬</li>
</ul>
<p>è¿™ä¸ªçŠ¶æ€å…¶å®å°±æ˜¯åç¨‹çš„çŠ¶æ€ã€‚</p>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»çŸ¥é“äº† <strong>Job</strong> ä»å“ªæ¥çš„ï¼Œé‚£ä¹ˆè¿™ä¸ª <strong>Job</strong> åˆ°åº•æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬ç”¨å‡ ä¸ªä¾‹å­æ¥è¯•ä¸€ä¸‹ã€‚</p>
<h2>Job æœ‰ä»€ä¹ˆç”¨</h2>
<p><img src="https://img.soogif.com/fCnkbyO30VyAxkMkMQMGzwWadCVCafE7.gif?scope=mdnice"><br>
åœ¨å†™ä¾‹å­ä¹‹å‰ï¼Œå…ˆåšä¸€ä¸‹å‰ç½®å‡†å¤‡ï¼š</p>
<ol>
<li>ç»™ IDEA è®¾ç½®ä¸€ä¸‹ VM å‚æ•°ï¼š<code class="notranslate">-Dkotlinx.coroutines.debug</code>ï¼Œè¿™æ ·æ‰“å°å‡ºæ¥çš„çº¿ç¨‹åå­—ä¸­å°±åŒ…å«äº†åç¨‹çš„ä¿¡æ¯ã€‚</li>
</ol>
<p><img src="https://blog-image.ian2018.cn/images/3a1ff93948b2260c5a0476ec4108ee40a7a22024.png"></p>
<ol start="2">
<li>log æ‰“å°æ–¹æ³•ï¼š</li>
</ol>
<div class="highlight highlight-source-kotlin"><pre class="notranslate"><span class="pl-c"><span class="pl-c">/*</span>*</span>
<span class="pl-c"> * æ‰“å° Job çš„çŠ¶æ€ä¿¡æ¯ï¼Œå°±æ˜¯æºç ä¸­çœ‹åˆ°çš„ state query é‚£éƒ¨åˆ†å†…å®¹</span>
<span class="pl-c"> <span class="pl-c">*/</span></span>
<span class="pl-k">fun</span> Job.<span class="pl-en">log</span>() {
    logX(
        <span class="pl-s"><span class="pl-pds">"""</span></span>
<span class="pl-s">        isActive = <span class="pl-e">$isActive</span></span>
<span class="pl-s">        isCancelled = <span class="pl-e">$isCancelled</span></span>
<span class="pl-s">        isCompleted = <span class="pl-e">$isCompleted</span></span>
<span class="pl-s">    <span class="pl-pds">"""</span></span>.trimIndent()
    )
}

<span class="pl-c"><span class="pl-c">/*</span>*</span>
<span class="pl-c"> * æ§åˆ¶å°è¾“å‡ºå¸¦åç¨‹ä¿¡æ¯çš„ log</span>
<span class="pl-c"> <span class="pl-c">*/</span></span>
<span class="pl-k">fun</span> <span class="pl-en">logX</span>(<span class="pl-smi">any</span><span class="pl-k">:</span> <span class="pl-c1">Any?</span>) {
    <span class="pl-c1">println</span>(
        <span class="pl-s"><span class="pl-pds">"""</span></span>
<span class="pl-s">================================</span>
<span class="pl-s"><span class="pl-e">$any</span></span>
<span class="pl-s">Thread:<span class="pl-e">${<span class="pl-en">Thread</span>.currentThread().name}</span></span>
<span class="pl-s">================================<span class="pl-pds">"""</span></span>.trimIndent()
    )
}</pre></div>
<h3>ä¸€ã€æµ‹è¯•é€šè¿‡ Job æŸ¥çœ‹åç¨‹çŠ¶æ€</h3>
<div class="highlight highlight-source-kotlin"><pre class="notranslate"><span class="pl-k">fun</span> <span class="pl-en">test1</span>() <span class="pl-k">=</span> runBlocking {
    <span class="pl-k">val</span> job <span class="pl-k">=</span> launch {
        delay(<span class="pl-c1">1000L</span>)
    }
    job.log()             <span class="pl-c"><span class="pl-c">//</span> â‘ </span>
    delay(<span class="pl-c1">1500L</span>)          <span class="pl-c"><span class="pl-c">//</span> â‘¡</span>
    job.log()             <span class="pl-c"><span class="pl-c">//</span> â‘¢</span>
}</pre></div>
<p>æ‰“å°ç»“æœï¼š</p>
<pre class="notranslate"><code class="notranslate">================================
isActive = true
isCancelled = false
isCompleted = false
Thread:main @coroutine#2
================================
================================
isActive = false
isCancelled = false
isCompleted = true
Thread:main @coroutine#2
================================
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåç¨‹ï¼Œåœ¨é‡Œé¢åšäº†ä¸€ä¸ªå»¶è¿Ÿ 1 ç§’é’Ÿçš„ä»»åŠ¡ï¼Œç„¶åé©¬ä¸Šé€šè¿‡ <strong>Job log</strong> æŸ¥çœ‹äº†ä¸€ä¸‹å½“å‰åç¨‹çš„çŠ¶æ€ï¼Œå‘ç° <strong>isActive</strong> æ˜¯ trueï¼Œå…¶ä»–éƒ½æ˜¯ falseï¼Œè¯´æ˜å½“å‰åç¨‹å±äºæ´»è·ƒçŠ¶æ€ã€‚</p>
<p>ç„¶åç­‰äº† 1.5 ç§’åï¼Œå†æ¬¡é€šè¿‡ <strong>Job log</strong> æŸ¥çœ‹åç¨‹çš„çŠ¶æ€ï¼Œå‘ç° <strong>isActive</strong> å˜æˆäº† falseï¼Œå¹¶ä¸” <strong>isCompleted</strong> å˜æˆäº† trueã€‚</p>
<p>é€šè¿‡è¿™äº›æˆ‘ä»¬å¤§æ¦‚å°±èƒ½çŸ¥é“ <strong>isActive</strong> å’Œ <strong>isCompleted</strong> çš„çŠ¶æ€å•¥æ—¶å€™ä¼šæ”¹å˜äº†å§ï¼Œè¿è¡Œåç¨‹æ—¶ <strong>isActive</strong> å°±æ˜¯ trueï¼Œç­‰åç¨‹è¿è¡Œå®Œæˆäº†ï¼Œ<strong>isCompleted</strong> å°±å˜æˆäº† trueã€‚</p>
<h3>äºŒã€æµ‹è¯•é€šè¿‡ Job æ›´æ–°åç¨‹çŠ¶æ€</h3>
<h4>1. <strong>Job</strong> çš„ <code class="notranslate">start</code> æ–¹æ³•</h4>
<p>è¦æƒ³ä½¿ç”¨ <code class="notranslate">start</code>ï¼Œæˆ‘ä»¬é¦–å…ˆå¾—æ”¹ä¸€ä¸‹ <code class="notranslate">launch</code> çš„å¯åŠ¨æ–¹å¼ï¼š</p>
<div class="highlight highlight-source-kotlin"><pre class="notranslate"><span class="pl-k">fun</span> <span class="pl-en">test2</span>() <span class="pl-k">=</span> runBlocking {
    <span class="pl-c"><span class="pl-c">//</span>                           å˜åŒ–åœ¨è¿™é‡Œ</span>
    <span class="pl-c"><span class="pl-c">//</span>                               â†“</span>
    <span class="pl-k">val</span> job <span class="pl-k">=</span> launch(start <span class="pl-k">=</span> <span class="pl-en">CoroutineStart</span>.<span class="pl-en">LAZY</span>) {
        logX(<span class="pl-s"><span class="pl-pds">"</span>Coroutine start!<span class="pl-pds">"</span></span>)
        delay(<span class="pl-c1">1000L</span>)
    }
    delay(<span class="pl-c1">1000L</span>)          <span class="pl-c"><span class="pl-c">//</span> â‘ </span>
    job.log()
    job.start()           <span class="pl-c"><span class="pl-c">//</span> â‘¡</span>
    job.log()
    delay(<span class="pl-c1">1500L</span>)          <span class="pl-c"><span class="pl-c">//</span> â‘¢</span>
    job.log()
}</pre></div>
<p>æ‰“å°ç»“æœï¼š</p>
<pre class="notranslate"><code class="notranslate">================================
isActive = false
isCancelled = false
isCompleted = false
Thread:main @coroutine#2
================================
================================
isActive = true
isCancelled = false
isCompleted = false
Thread:main @coroutine#2
================================
================================
Coroutine start!
Thread:main @coroutine#3
================================
================================
isActive = false
isCancelled = false
isCompleted = true
Thread:main @coroutine#2
================================
</code></pre>
<p>ä¸Šé¢ä»£ç æˆ‘ä»¬åœ¨åˆ›å»ºåç¨‹çš„æ—¶å€™å°† start å‚æ•°è®¾ç½®æˆäº† <strong>LAZY</strong>ï¼Œè¿™æ ·åˆ›å»ºåç¨‹æ—¶å°±ä¸ä¼šå¯åŠ¨äº†ã€‚</p>
<p>ç„¶åå»¶è¿Ÿäº† 1 ç§’é’Ÿï¼ŒæŸ¥çœ‹äº†ä¸€ä¸‹åç¨‹çš„çŠ¶æ€ï¼Œä¼šå‘ç° <strong>isActive</strong> æ˜¯ falseï¼Œ<strong>isCompleted</strong> ä¹Ÿæ˜¯ falseã€‚</p>
<p>å½“æˆ‘ä»¬è°ƒç”¨äº† Job çš„ <code class="notranslate">start</code> æ–¹æ³•åï¼Œå†æ¬¡æŸ¥çœ‹çŠ¶æ€ï¼Œ<strong>isActive</strong> å˜æˆäº† trueï¼Œå¹¶ä¸”åç¨‹ä¸­çš„ä»»åŠ¡ä¹Ÿæ‰“å°äº† â€œCoroutine start!â€ï¼Œè¯´æ˜è°ƒäº† <code class="notranslate">start</code> æ–¹æ³•ä¹‹åä¼šæŠŠåç¨‹æ¿€æ´»ã€‚</p>
<p>åˆç­‰äº† 1.5 ç§’åï¼Œåç¨‹ä¹Ÿæ­£å¸¸ç»“æŸäº†ã€‚</p>
<h4>2. <strong>Job</strong> çš„ <code class="notranslate">cancel</code> æ–¹æ³•ï¼š</h4>
<div class="highlight highlight-source-kotlin"><pre class="notranslate"><span class="pl-k">fun</span> <span class="pl-en">test4</span>() <span class="pl-k">=</span> runBlocking {
    <span class="pl-k">val</span> job <span class="pl-k">=</span> launch(start <span class="pl-k">=</span> <span class="pl-en">CoroutineStart</span>.<span class="pl-en">LAZY</span>) {
        logX(<span class="pl-s"><span class="pl-pds">"</span>Coroutine start!<span class="pl-pds">"</span></span>)
        delay(<span class="pl-c1">1000L</span>)
        logX(<span class="pl-s"><span class="pl-pds">"</span>Coroutine end!<span class="pl-pds">"</span></span>)
    }
    delay(<span class="pl-c1">500L</span>)
    job.log()
    job.start()
    job.log()
    delay(<span class="pl-c1">500L</span>)           <span class="pl-c"><span class="pl-c">//</span> â‘ </span>
    job.cancel()          <span class="pl-c"><span class="pl-c">//</span> â‘¡</span>
    job.log()             <span class="pl-c"><span class="pl-c">//</span> â‘¢</span>
    delay(<span class="pl-c1">2000L</span>)          <span class="pl-c"><span class="pl-c">//</span> â‘£</span>
    job.log()             <span class="pl-c"><span class="pl-c">//</span> â‘¤</span>
}</pre></div>
<p>æ‰“å°ç»“æœï¼š</p>
<pre class="notranslate"><code class="notranslate">================================
isActive = false
isCancelled = false
isCompleted = false
Thread:main @coroutine#2
================================
================================
isActive = true
isCancelled = false
isCompleted = false
Thread:main @coroutine#2
================================
================================
Coroutine start!
Thread:main @coroutine#3
================================
================================
isActive = false
isCancelled = true
isCompleted = false
Thread:main @coroutine#2
================================
================================
isActive = false
isCancelled = true
isCompleted = true
Thread:main @coroutine#2
================================
</code></pre>
<p>æˆ‘ä»¬è¿˜æ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ‡’åŠ è½½çš„åç¨‹ï¼Œå¯åŠ¨å®ƒ 500 æ¯«ç§’ä¹‹åï¼Œè°ƒç”¨äº† <strong>Job</strong> çš„ <code class="notranslate">cancel</code> æ–¹æ³•ï¼Œè¿™æ—¶å»æŸ¥çœ‹åç¨‹çš„çŠ¶æ€ï¼Œä¼šå‘ç° <strong>isActive</strong> å˜æˆäº† falseï¼Œ<strong>isCancelled</strong> å˜æˆäº† trueã€‚</p>
<p>ç­‰åˆè¿‡äº† 2 ç§’ï¼Œæˆ‘ä»¬å†æ¬¡æŸ¥çœ‹åç¨‹çš„çŠ¶æ€ï¼Œå‘ç° <strong>isCompleted</strong> ä¹Ÿå˜æˆäº† trueï¼Œå¹¶ä¸”æœ€ååç¨‹ä»»åŠ¡ä¸­çš„ â€œCoroutine end!â€ ä¹Ÿæ²¡æœ‰æ‰“å°å‡ºæ¥ã€‚è¯´æ˜ <code class="notranslate">cancel</code> æ–¹æ³•ä¼šæŠŠåç¨‹ä»»åŠ¡å–æ¶ˆæ‰ã€‚</p>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å‘ç° <strong>Job</strong> ä¹Ÿæœ‰ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œæ²¡é”™ï¼ŒJob çš„æºç æ³¨é‡Šä¸­å°±å·²ç»è¯´æ˜äº†ï¼š</p>
<p><img src="https://blog-image.ian2018.cn/images/02d149556182e6f048337afa6517fb40ab000c88.png"></p>
<p><img src="https://blog-image.ian2018.cn/images/617ccf573494e8efa04ebfd5d14927932b39cf00.png"></p>
<p>ä»ä¸Šé¢æˆ‘ä»¬å°±èƒ½æ¸…æ™°çš„çœ‹åˆ°æ•´ä¸ª <strong>Job</strong> çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p>ä½†æ˜¯æœ‰ä¸ªå¥‡æ€ªçš„ç‚¹ï¼Œä¸Šé¢ä»£ç æ‰§è¡Œç»“æœå‡ºç°äº† <strong>isCancelled</strong> å’Œ <strong>isCompleted</strong> åŒæ—¶éƒ½ä¸º true çš„æƒ…å†µï¼Œè¿™åœ¨å›¾ä¸­çš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ²¡æœ‰ä½“ç°çš„ã€‚</p>
<p>è¿™æ˜¯å› ä¸ºï¼Œåç¨‹è®¤ä¸ºç”±äºæŸç§åŸå› å–æ¶ˆçš„åç¨‹ï¼Œä¹Ÿä»ç„¶æ˜¯ä¸€ç§â€œç»“æŸçŠ¶æ€â€ã€‚æ‰€ä»¥æµç¨‹å›¾å½“ä¸­çš„ Newã€Activeã€Completingã€Cancellingã€Completedã€Cancelled è¿™äº›çŠ¶æ€ï¼Œå…¶å®éƒ½æ˜¯ <strong>Job</strong> å†…éƒ¨ç§æœ‰çš„çŠ¶æ€ï¼Œè€Œ <strong>Job</strong> å¯¹å¤–æš´éœ²å‡ºçš„ <strong>isCompleted</strong> å¹¶ä¸æ˜¯ä¸å…¶ä¸€ä¸€å¯¹åº”çš„ã€‚</p>
<p>Android ä¸­çš„ <code class="notranslate">lifecycleScope</code> å°±æ˜¯åœ¨ onDestroy çš„æ—¶å€™ï¼Œé€šè¿‡ <strong>Job</strong> å°†åç¨‹ cancel æ‰äº†ï¼Œè¿™æ‰æœ‰äº†å’Œ Activity/Fragment ç”Ÿå‘½å‘¨æœŸç»‘å®šçš„ scopeï¼Œæ‰€ä»¥å¤§å®¶åˆ›å»ºåç¨‹çš„æ—¶å€™ï¼Œå°½é‡éƒ½ç”¨è¿™ä¸ª scopeï¼Œä¸è¦ç”¨å…¨å±€çš„ï¼Œé™¤éè¿™ä¸ªä»»åŠ¡å°±æ˜¯éœ€è¦å…¨å±€è¿è¡Œçš„ã€‚</p>
<h3>ä¸‰ã€æµ‹è¯•é€šè¿‡ Job ç­‰å¾…åç¨‹è¿è¡Œ</h3>
<h4>1. Job çš„ join</h4>
<p>å‰é¢å‡ ä¸ªä¾‹å­æˆ‘ä»¬æ˜¯éƒ½çŸ¥é“åç¨‹ä¸­çš„ä»»åŠ¡æ‰§è¡Œäº†å¤šä¹…ï¼Œç„¶åå»æŸ¥çœ‹åç¨‹çš„çŠ¶æ€ã€‚ä½†å®é™…å¼€å‘ä¸­æˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯ä¸èƒ½æå‰çŸ¥é“çš„ï¼Œå°±æ¯”å¦‚è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ç”¨ <strong>Job</strong> çš„ <code class="notranslate">join</code> æ–¹æ³•äº†ã€‚</p>
<div class="highlight highlight-source-kotlin"><pre class="notranslate"><span class="pl-k">fun</span> <span class="pl-en">test5</span>() <span class="pl-k">=</span> runBlocking {
    <span class="pl-k">suspend</span> <span class="pl-k">fun</span> <span class="pl-en">download</span>() {
        <span class="pl-c"><span class="pl-c">//</span> æ¨¡æ‹Ÿä¸‹è½½ä»»åŠ¡</span>
        <span class="pl-k">val</span> time <span class="pl-k">=</span> (<span class="pl-en">Random</span>.nextDouble() <span class="pl-k">*</span> <span class="pl-c1">1000</span>).toLong()
        logX(<span class="pl-s"><span class="pl-pds">"</span>Delay time: = <span class="pl-e">$time</span><span class="pl-pds">"</span></span>)
        delay(time)
    }

    <span class="pl-k">val</span> job <span class="pl-k">=</span> launch {
        logX(<span class="pl-s"><span class="pl-pds">"</span>Coroutine start!<span class="pl-pds">"</span></span>)
        download()
        logX(<span class="pl-s"><span class="pl-pds">"</span>Coroutine end!<span class="pl-pds">"</span></span>)
    }
    job.log()
    job.join()      <span class="pl-c"><span class="pl-c">//</span> ç­‰å¾…åç¨‹æ‰§è¡Œå®Œæ¯•</span>
    job.log()
}</pre></div>
<p>æ‰“å°ç»“æœï¼š</p>
<pre class="notranslate"><code class="notranslate">================================
isActive = true
isCancelled = false
isCompleted = false
Thread:main @coroutine#2
================================
================================
Coroutine start!
Thread:main @coroutine#3
================================
================================
Delay time: = 456
Thread:main @coroutine#3
================================
================================
Coroutine end!
Thread:main @coroutine#3
================================
================================
isActive = false
isCancelled = false
isCompleted = true
Thread:main @coroutine#2
================================
</code></pre>
<p><code class="notranslate">join</code> æ˜¯ä¸ªæŒ‚èµ·å‡½æ•°ï¼Œæ‰€ä»¥æ‰§è¡Œåˆ° join é‚£é‡Œä¼šæŠŠä»£ç æŒ‚èµ·ï¼Œç­‰åç¨‹è¿è¡Œå®Œæˆåï¼Œåé¢çš„ä»£ç æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚</p>
<p>å¦å¤–æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ç»™ <strong>Job</strong> æ·»åŠ ä¸€ä¸ªé€šçŸ¥å›è°ƒçš„æ–¹å¼ï¼Œæ¥çŸ¥é“åç¨‹è¿è¡Œå®Œæˆï¼Œè¿™å¯ä»¥ä½¿ç”¨ <strong>Job</strong> çš„ <code class="notranslate">invokeOnCompletion</code>ï¼š</p>
<div class="highlight highlight-source-kotlin"><pre class="notranslate"><span class="pl-k">fun</span> <span class="pl-en">test6</span>() <span class="pl-k">=</span> runBlocking {
    <span class="pl-k">suspend</span> <span class="pl-k">fun</span> <span class="pl-en">download</span>() {
        <span class="pl-c"><span class="pl-c">//</span> æ¨¡æ‹Ÿä¸‹è½½ä»»åŠ¡</span>
        <span class="pl-k">val</span> time <span class="pl-k">=</span> (<span class="pl-en">Random</span>.nextDouble() <span class="pl-k">*</span> <span class="pl-c1">1000</span>).toLong()
        logX(<span class="pl-s"><span class="pl-pds">"</span>Delay time: = <span class="pl-e">$time</span><span class="pl-pds">"</span></span>)
        delay(time)
    }

    <span class="pl-k">val</span> job <span class="pl-k">=</span> launch {
        logX(<span class="pl-s"><span class="pl-pds">"</span>Coroutine start!<span class="pl-pds">"</span></span>)
        download()
        logX(<span class="pl-s"><span class="pl-pds">"</span>Coroutine end!<span class="pl-pds">"</span></span>)
    }
    job.log()
    job.invokeOnCompletion {
        job.log()   <span class="pl-c"><span class="pl-c">//</span> åç¨‹ç»“æŸä»¥åå°±ä¼šè°ƒç”¨è¿™é‡Œçš„ä»£ç </span>
    }
    job.join()      <span class="pl-c"><span class="pl-c">//</span> ç­‰å¾…åç¨‹æ‰§è¡Œå®Œæ¯•</span>
}</pre></div>
<p>æ‰“å°ç»“æœï¼š</p>
<pre class="notranslate"><code class="notranslate">================================
isActive = true
isCancelled = false
isCompleted = false
Thread:main @coroutine#2
================================
================================
Coroutine start!
Thread:main @coroutine#3
================================
================================
Delay time: = 170
Thread:main @coroutine#3
================================
================================
Coroutine end!
Thread:main @coroutine#3
================================
================================
isActive = false
isCancelled = false
isCompleted = true
Thread:main @coroutine#3
================================
</code></pre>
<p>å¯ä»¥çœ‹åˆ°æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨ä»£ç å…¶ä»–åœ°æ–¹æ¥ç›‘å¬åç¨‹çš„è¿è¡Œäº†ã€‚</p>
<p>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåç¨‹è¢« <code class="notranslate">cancel</code> äº†ä¹ŸåŒæ ·ä¼šå›è°ƒï¼š</p>
<div class="highlight highlight-source-kotlin"><pre class="notranslate"><span class="pl-k">fun</span> <span class="pl-en">test6</span>() <span class="pl-k">=</span> runBlocking {
    <span class="pl-k">suspend</span> <span class="pl-k">fun</span> <span class="pl-en">download</span>() {
        <span class="pl-c"><span class="pl-c">//</span> æ¨¡æ‹Ÿä¸‹è½½ä»»åŠ¡</span>
        <span class="pl-k">val</span> time <span class="pl-k">=</span> (<span class="pl-en">Random</span>.nextDouble() <span class="pl-k">*</span> <span class="pl-c1">1000</span>).toLong()
        logX(<span class="pl-s"><span class="pl-pds">"</span>Delay time: = <span class="pl-e">$time</span><span class="pl-pds">"</span></span>)
        delay(time)
    }

    <span class="pl-k">val</span> job <span class="pl-k">=</span> launch {
        logX(<span class="pl-s"><span class="pl-pds">"</span>Coroutine start!<span class="pl-pds">"</span></span>)
        download()
        logX(<span class="pl-s"><span class="pl-pds">"</span>Coroutine end!<span class="pl-pds">"</span></span>)
    }
    job.log()
    job.invokeOnCompletion {
        job.log()   <span class="pl-c"><span class="pl-c">//</span> åç¨‹ç»“æŸä»¥åå°±ä¼šè°ƒç”¨è¿™é‡Œçš„ä»£ç </span>
    }
    job.cancel()    <span class="pl-c"><span class="pl-c">//</span> å–æ¶ˆåç¨‹</span>
}</pre></div>
<p>æ‰“å°ç»“æœï¼š</p>
<pre class="notranslate"><code class="notranslate">================================
isActive = true
isCancelled = false
isCompleted = false
Thread:main @coroutine#2
================================
================================
isActive = false
isCancelled = true
isCompleted = true
Thread:main @coroutine#3
================================
</code></pre>
<h4>2. Deferred çš„ await</h4>
<p><strong>Deferred</strong> ç»§æ‰¿äº† <strong>Job</strong> ä½†åªæ¯” <strong>Job</strong> å¤šäº†ä¸€ä¸ª <code class="notranslate">await</code> æ–¹æ³•ï¼š<br>
<img src="https://blog-image.ian2018.cn/images/21f6a4af8d7d547f837157d606f3a0a33d2d4c15.png"></p>
<p>å’Œ <code class="notranslate">join</code> ç±»ä¼¼ï¼Œ<code class="notranslate">await</code> ä¹Ÿæ˜¯å¯ä»¥ç­‰å¾…åç¨‹è¿è¡Œå®Œæˆï¼Œåªä¸è¿‡ <code class="notranslate">await</code> æ˜¯æœ‰è¿”å›å€¼çš„ï¼Œå¯ä»¥æ‹¿åˆ°åç¨‹çš„è¿è¡Œç»“æœï¼š</p>
<div class="highlight highlight-source-kotlin"><pre class="notranslate"><span class="pl-k">fun</span> <span class="pl-en">test7</span>() <span class="pl-k">=</span> runBlocking {
    <span class="pl-k">suspend</span> <span class="pl-k">fun</span> <span class="pl-en">download</span>(): <span class="pl-c1">String</span> {
        <span class="pl-c"><span class="pl-c">//</span> æ¨¡æ‹Ÿä¸‹è½½ä»»åŠ¡</span>
        <span class="pl-k">val</span> time <span class="pl-k">=</span> (<span class="pl-en">Random</span>.nextDouble() <span class="pl-k">*</span> <span class="pl-c1">1000</span>).toLong()
        logX(<span class="pl-s"><span class="pl-pds">"</span>Delay time: = <span class="pl-e">$time</span><span class="pl-pds">"</span></span>)
        delay(time)
        <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>download result!<span class="pl-pds">"</span></span>
    }
    
    <span class="pl-k">val</span> deferred <span class="pl-k">=</span> async {
        logX(<span class="pl-s"><span class="pl-pds">"</span>Coroutine start!<span class="pl-pds">"</span></span>)
        <span class="pl-k">val</span> result <span class="pl-k">=</span> download()
        logX(<span class="pl-s"><span class="pl-pds">"</span>Coroutine end!<span class="pl-pds">"</span></span>)
        <span class="pl-k">return</span>@async result
    }
    <span class="pl-k">val</span> result <span class="pl-k">=</span> deferred.await()
    <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>Result = <span class="pl-e">$result</span><span class="pl-pds">"</span></span>)
    logX(<span class="pl-s"><span class="pl-pds">"</span>Process end!<span class="pl-pds">"</span></span>)
}</pre></div>
<p>æ‰“å°ç»“æœï¼š</p>
<pre class="notranslate"><code class="notranslate">================================
Coroutine start!
Thread:main @coroutine#3
================================
================================
Delay time: = 263
Thread:main @coroutine#3
================================
================================
Coroutine end!
Thread:main @coroutine#3
================================
Result = download result!
================================
Process end!
Thread:main @coroutine#2
================================
</code></pre>
<p><code class="notranslate">await</code> ä¹Ÿæ˜¯ä¸€ä¸ªæŒ‚èµ·å‡½æ•°ï¼Œé€šè¿‡ <code class="notranslate">await</code> æˆ‘ä»¬æ‹¿åˆ°äº† <code class="notranslate">async</code> åç¨‹çš„è¿è¡Œç»“æœã€‚è¿™é‡Œå¯ä»¥å†å›å¿†ä¸€ä¸‹æŒ‚èµ·å‡½æ•°çš„è¿è¡Œæ¨¡å‹ï¼š<br>
<img src="https://blog-image.ian2018.cn/images/845ae9cde2593556965e11f079cdf3146bb1cea2.gif"></p>
<p>é€šè¿‡ä¸Šé¢å‡ ä¸ªä¾‹å­æˆ‘ä»¬åº”è¯¥å·²ç»çŸ¥é“äº† <strong>Job</strong> æœ‰ä»€ä¹ˆç”¨äº†å§ï¼Œå…¶å® <strong>Job</strong> å°±æ˜¯ç”¨æ¥æ§åˆ¶åç¨‹çš„ï¼Œä¹Ÿå°±æ˜¯ <strong>Job</strong> æ˜¯åç¨‹çš„å¥æŸ„ã€‚è¿™é‡Œå¯ä»¥ç±»æ¯”é¥æ§å™¨å’Œç©ºè°ƒçš„å…³ç³»ï¼š</p>
<ul>
<li>ç©ºè°ƒé¥æ§å™¨å¯ä»¥ç›‘æµ‹ç©ºè°ƒçš„è¿è¡ŒçŠ¶æ€ï¼›Job ä¹Ÿå¯ä»¥ç›‘æµ‹åç¨‹çš„è¿è¡ŒçŠ¶æ€ï¼›</li>
<li>ç©ºè°ƒé¥æ§å™¨å¯ä»¥æ“æ§ç©ºè°ƒçš„è¿è¡ŒçŠ¶æ€ï¼ŒJob ä¹Ÿå¯ä»¥ç®€å•æ“æ§åç¨‹çš„è¿è¡ŒçŠ¶æ€ã€‚</li>
</ul>
<p>é‚£ä¹ˆç°åœ¨ <strong>Job</strong> è¿˜å‰©æœ€åä¸€å—ã€Œparent-childã€ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªçˆ¶å­å…³ç³»åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<h2>ç»“æ„åŒ–å¹¶å‘</h2>
<p><strong>Job</strong> ä¸­çš„ <code class="notranslate">children</code> å…¶å®æ˜¯å’Œç»“æ„åŒ–å¹¶å‘æœ‰å…³çš„ï¼Œè¿™ä¹Ÿæ˜¯åç¨‹çš„å¦ä¸€å¤§ç‰¹è‰²ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯ç»“æ„åŒ–å¹¶å‘å‘¢ï¼Ÿä»å­—é¢ä¸Šçœ‹å°±æ˜¯æœ‰ç»“æ„çš„å¹¶å‘ï¼ˆåºŸè¯æ–‡å­¦äº†ğŸ™„ï¼‰ï¼Œè¿˜æ˜¯çœ‹å‡ ä¸ªä¾‹å­å§ï¼š</p>
<div class="highlight highlight-source-kotlin"><pre class="notranslate"><span class="pl-k">fun</span> <span class="pl-en">test8</span>() <span class="pl-k">=</span> runBlocking {
    <span class="pl-k">val</span> parentJob<span class="pl-k">:</span> <span class="pl-en">Job</span>
    <span class="pl-k">var</span> job1<span class="pl-k">:</span> <span class="pl-en">Job</span><span class="pl-k">?</span> <span class="pl-k">=</span> <span class="pl-c1">null</span>
    <span class="pl-k">var</span> job2<span class="pl-k">:</span> <span class="pl-en">Job</span><span class="pl-k">?</span> <span class="pl-k">=</span> <span class="pl-c1">null</span>
    <span class="pl-k">var</span> job3<span class="pl-k">:</span> <span class="pl-en">Job</span><span class="pl-k">?</span> <span class="pl-k">=</span> <span class="pl-c1">null</span>
    parentJob <span class="pl-k">=</span> launch {
        job1 <span class="pl-k">=</span> launch {
            delay(<span class="pl-c1">1000L</span>)
        }
        job2 <span class="pl-k">=</span> launch {
            delay(<span class="pl-c1">3000L</span>)
        }
        job3 <span class="pl-k">=</span> launch {
            delay(<span class="pl-c1">5000L</span>)
        }
    }
    delay(<span class="pl-c1">500L</span>)
    parentJob.children.forEachIndexed { index, job <span class="pl-k">-&gt;</span>
        <span class="pl-k">when</span> (index) {
            <span class="pl-c1">0</span> <span class="pl-k">-&gt;</span> <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>job1 === job is <span class="pl-e">${job1 <span class="pl-k">==</span><span class="pl-k">=</span> job}</span><span class="pl-pds">"</span></span>)
            <span class="pl-c1">1</span> <span class="pl-k">-&gt;</span> <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>job2 === job is <span class="pl-e">${job2 <span class="pl-k">==</span><span class="pl-k">=</span> job}</span><span class="pl-pds">"</span></span>)
            <span class="pl-c1">2</span> <span class="pl-k">-&gt;</span> <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>job3 === job is <span class="pl-e">${job3 <span class="pl-k">==</span><span class="pl-k">=</span> job}</span><span class="pl-pds">"</span></span>)
        }
    }
    parentJob.join() <span class="pl-c"><span class="pl-c">//</span> è¿™é‡Œä¼šæŒ‚èµ·å¤§çº¦5ç§’é’Ÿ</span>
    logX(<span class="pl-s"><span class="pl-pds">"</span>Process end!<span class="pl-pds">"</span></span>)
}</pre></div>
<p>æ‰“å°ç»“æœï¼š</p>
<pre class="notranslate"><code class="notranslate">job1 === job is true
job2 === job is true
job3 === job is true
================================
Process end!
Thread:main @coroutine#2
================================
</code></pre>
<p>ä¸Šé¢ä»£ç ä¸­æˆ‘ä»¬åœ¨ä¸€ä¸ª launch å—ä¸­åˆåˆ›å»ºäº† 3 ä¸ª launchï¼Œå¾—åˆ°äº† parentJob å’Œ job 1-3ï¼Œç„¶åæ¯”è¾ƒäº† parentJob çš„ children å’Œ job 1-3 æ˜¯å¦ç›¸ç­‰ã€‚ä»ç»“æœä¸Šçœ‹ï¼Œå®ƒä»¬å°±æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ launch åˆ›å»ºçš„åç¨‹æ˜¯æœ‰çˆ¶å­å…³ç³»çš„ï¼Œå®ƒä»¬ç»“æ„å¤§æ¦‚æ˜¯ä¸‹é¢è¿™æ ·ï¼š<br>
<img src="https://blog-image.ian2018.cn/images/18b29a89ce5307f9a9e28ddf5a262e5c2e038175.png"></p>
<p>è¿˜æœ‰ parentJob æ‰§è¡Œ join çš„æ—¶å€™å¤§æ¦‚æŒ‚èµ·äº† 5 ç§’ï¼Œè€Œå­åç¨‹ä¸­æœ€é•¿çš„ä»»åŠ¡å°±æ˜¯ 5 ç§’ï¼Œè¿™è¯´æ˜çˆ¶åç¨‹ä¼šç­‰æ‰€æœ‰å­åç¨‹å…¨éƒ¨å®Œæˆåï¼Œæ‰ä¼šç»“æŸï¼š<br>
<img src="https://blog-image.ian2018.cn/images/08a9b255f24248d65e4e90828fc1ffaebc492437.gif"></p>
<p>ç„¶åæˆ‘ä»¬å†è¯•è¯• cancel çš„æƒ…å†µï¼š</p>
<div class="highlight highlight-source-kotlin"><pre class="notranslate"><span class="pl-k">fun</span> <span class="pl-en">test9</span>() <span class="pl-k">=</span> runBlocking {
    <span class="pl-k">val</span> parentJob<span class="pl-k">:</span> <span class="pl-en">Job</span>
    <span class="pl-k">var</span> job1<span class="pl-k">:</span> <span class="pl-en">Job</span><span class="pl-k">?</span> <span class="pl-k">=</span> <span class="pl-c1">null</span>
    <span class="pl-k">var</span> job2<span class="pl-k">:</span> <span class="pl-en">Job</span><span class="pl-k">?</span> <span class="pl-k">=</span> <span class="pl-c1">null</span>
    <span class="pl-k">var</span> job3<span class="pl-k">:</span> <span class="pl-en">Job</span><span class="pl-k">?</span> <span class="pl-k">=</span> <span class="pl-c1">null</span>
    parentJob <span class="pl-k">=</span> launch {
        job1 <span class="pl-k">=</span> launch {
            logX(<span class="pl-s"><span class="pl-pds">"</span>Job1 start!<span class="pl-pds">"</span></span>)
            delay(<span class="pl-c1">1000L</span>)
            logX(<span class="pl-s"><span class="pl-pds">"</span>Job1 done!<span class="pl-pds">"</span></span>) <span class="pl-c"><span class="pl-c">//</span> â‘ ï¼Œä¸ä¼šæ‰§è¡Œ</span>
        }
        job2 <span class="pl-k">=</span> launch {
            logX(<span class="pl-s"><span class="pl-pds">"</span>Job2 start!<span class="pl-pds">"</span></span>)
            delay(<span class="pl-c1">3000L</span>)
            logX(<span class="pl-s"><span class="pl-pds">"</span>Job2 done!<span class="pl-pds">"</span></span>) <span class="pl-c"><span class="pl-c">//</span> â‘¡ï¼Œä¸ä¼šæ‰§è¡Œ</span>
        }
        job3 <span class="pl-k">=</span> launch {
            logX(<span class="pl-s"><span class="pl-pds">"</span>Job3 start!<span class="pl-pds">"</span></span>)
            delay(<span class="pl-c1">5000L</span>)
            logX(<span class="pl-s"><span class="pl-pds">"</span>Job3 done!<span class="pl-pds">"</span></span>)<span class="pl-c"><span class="pl-c">//</span> â‘¢ï¼Œä¸ä¼šæ‰§è¡Œ</span>
        }
    }
    delay(<span class="pl-c1">500L</span>)
    parentJob.children.forEachIndexed { index, job <span class="pl-k">-&gt;</span>
        <span class="pl-k">when</span> (index) {
            <span class="pl-c1">0</span> <span class="pl-k">-&gt;</span> <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>job1 === job is <span class="pl-e">${job1 <span class="pl-k">==</span><span class="pl-k">=</span> job}</span><span class="pl-pds">"</span></span>)
            <span class="pl-c1">1</span> <span class="pl-k">-&gt;</span> <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>job2 === job is <span class="pl-e">${job2 <span class="pl-k">==</span><span class="pl-k">=</span> job}</span><span class="pl-pds">"</span></span>)
            <span class="pl-c1">2</span> <span class="pl-k">-&gt;</span> <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>job3 === job is <span class="pl-e">${job3 <span class="pl-k">==</span><span class="pl-k">=</span> job}</span><span class="pl-pds">"</span></span>)
        }
    }
    parentJob.cancel() <span class="pl-c"><span class="pl-c">//</span> å˜åŒ–åœ¨è¿™é‡Œ</span>
    logX(<span class="pl-s"><span class="pl-pds">"</span>Process end!<span class="pl-pds">"</span></span>)
}</pre></div>
<p>æ‰“å°ç»“æœï¼š</p>
<pre class="notranslate"><code class="notranslate">================================
Job1 start!
Thread:main @coroutine#4
================================
================================
Job2 start!
Thread:main @coroutine#5
================================
================================
Job3 start!
Thread:main @coroutine#6
================================
job1 === job is true
job2 === job is true
job3 === job is true
================================
Process end!
Thread:main @coroutine#2
================================
</code></pre>
<p>ä¸Šé¢ä»£ç æˆ‘ä»¬è°ƒç”¨äº† parentJob çš„ <code class="notranslate">cancel</code>ï¼Œä¼šå‘ç°ç›´åˆ°æ•´ä¸ªç¨‹åºç»“æŸäº† job 1-3 ä¹Ÿä¸ä¼šæ‰§è¡Œç»“æŸã€‚è¯´æ˜çˆ¶åç¨‹å–æ¶ˆäº†ï¼Œè¿å¸¦æ‰€æœ‰çš„å­åç¨‹ä¹Ÿä¼šè·Ÿç€å–æ¶ˆï¼š<br>
<img src="https://blog-image.ian2018.cn/images/be55bf136e50c207113f77878f5e10f81db62c3d.gif"></p>
<p>åˆ°è¿™å·®ä¸å¤šèƒ½ç†è§£ä»€ä¹ˆæ˜¯ç»“æ„åŒ–å¹¶å‘äº†å§ï¼Œå°±æ˜¯å¸¦æœ‰ç»“æ„å’Œå±‚çº§çš„å¹¶å‘ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¸¾å‡ ä¸ªæ¯”è¾ƒå®ç”¨çš„ä¾‹å­ã€‚</p>
<h2>å®é™…åº”ç”¨</h2>
<p>éœ€æ±‚å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼šä¸€ä¸ªç…§ç‰‡è¯¦æƒ…é¡µï¼Œæœ‰ä¸‰ä¸ªæ¥å£ï¼Œåˆ†åˆ«æ˜¯è·å–ç…§ç‰‡è¯¦æƒ…ä¿¡æ¯ã€è·å–ç…§ç‰‡ç‚¹èµåˆ—è¡¨ã€è·å–ç…§ç‰‡è¯„è®ºåˆ—è¡¨ï¼Œè¿™ä¸‰ä¸ªæ¥å£ä¹‹å‰æ²¡æœ‰è€¦åˆï¼Œåªæœ‰ä¸‰ä¸ªæ¥å£å…¨éƒ½è·å–åˆ°ä¿¡æ¯æ‰èƒ½è¿›è¡Œ UI å±•ç¤ºã€‚</p>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ä¸€èˆ¬å†™æ³•ï¼š</p>
<div class="highlight highlight-source-kotlin"><pre class="notranslate"><span class="pl-k">fun</span> <span class="pl-en">test10</span>() <span class="pl-k">=</span> runBlocking {
    <span class="pl-k">suspend</span> <span class="pl-k">fun</span> <span class="pl-en">getPhotoInfo</span>(): <span class="pl-c1">String</span> {
        delay(<span class="pl-c1">1000L</span>) <span class="pl-c"><span class="pl-c">//</span> æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span>
        <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>photo info<span class="pl-pds">"</span></span>
    }
    <span class="pl-k">suspend</span> <span class="pl-k">fun</span> <span class="pl-en">getPhotoLikeList</span>(): <span class="pl-c1">String</span> {
        delay(<span class="pl-c1">1000L</span>) <span class="pl-c"><span class="pl-c">//</span> æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span>
        <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>photo like list<span class="pl-pds">"</span></span>
    }
    <span class="pl-k">suspend</span> <span class="pl-k">fun</span> <span class="pl-en">getPhotoCommentList</span>(): <span class="pl-c1">String</span> {
        delay(<span class="pl-c1">1000L</span>) <span class="pl-c"><span class="pl-c">//</span> æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span>
        <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>photo comment list<span class="pl-pds">"</span></span>
    }

    <span class="pl-k">val</span> deferred <span class="pl-k">=</span> async {
        <span class="pl-k">val</span> results <span class="pl-k">=</span> mutableListOf&lt;<span class="pl-en">String</span>&gt;()
        <span class="pl-c"><span class="pl-c">//</span> measureTimeMillis æ˜¯ kotlin é‡Œä¸€ä¸ªç»Ÿè®¡æ‰§è¡Œæ—¶é—´çš„æ–¹æ³•</span>
        <span class="pl-k">val</span> time <span class="pl-k">=</span> measureTimeMillis {
            results.add(getPhotoInfo())
            results.add(getPhotoLikeList())
            results.add(getPhotoCommentList())
        }
        <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>Cost Time: <span class="pl-e">$time</span><span class="pl-pds">"</span></span>)
        results
    }
    
    <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>å¼€å§‹å±•ç¤º UI: <span class="pl-e">${deferred.await()}</span><span class="pl-pds">"</span></span>)
}</pre></div>
<p>æ‰“å°ç»“æœï¼š</p>
<pre class="notranslate"><code class="notranslate">Cost Time: 3015
å¼€å§‹å±•ç¤º UI: [photo info, photo like list, photo comment list]
</code></pre>
<p>æˆ‘ä»¬å†™äº† 3 ä¸ªæŒ‚èµ·å‡½æ•°æ¨¡æ‹Ÿ 3 ä¸ªæ¥å£çš„è¯·æ±‚ï¼Œç„¶åç›´æ¥åœ¨åç¨‹é‡Œå°±å»åˆ†åˆ«è¯·æ±‚äº†ï¼Œå¤§æ¦‚æ¶ˆè€— 3 ç§’æ‰ç»“æŸã€‚</p>
<p>ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹ä¼˜åŒ–åçš„ï¼š</p>
<div class="highlight highlight-source-kotlin"><pre class="notranslate"><span class="pl-k">fun</span> <span class="pl-en">test11</span>() <span class="pl-k">=</span> runBlocking {
    <span class="pl-k">suspend</span> <span class="pl-k">fun</span> <span class="pl-en">getPhotoInfo</span>(): <span class="pl-c1">String</span> {
        delay(<span class="pl-c1">1000L</span>) <span class="pl-c"><span class="pl-c">//</span> æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span>
        <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>photo info<span class="pl-pds">"</span></span>
    }
    <span class="pl-k">suspend</span> <span class="pl-k">fun</span> <span class="pl-en">getPhotoLikeList</span>(): <span class="pl-c1">String</span> {
        delay(<span class="pl-c1">1000L</span>) <span class="pl-c"><span class="pl-c">//</span> æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span>
        <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>photo like list<span class="pl-pds">"</span></span>
    }
    <span class="pl-k">suspend</span> <span class="pl-k">fun</span> <span class="pl-en">getPhotoCommentList</span>(): <span class="pl-c1">String</span> {
        delay(<span class="pl-c1">1000L</span>) <span class="pl-c"><span class="pl-c">//</span> æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span>
        <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>photo comment list<span class="pl-pds">"</span></span>
    }

    <span class="pl-k">val</span> deferred <span class="pl-k">=</span> async {
        <span class="pl-k">val</span> results<span class="pl-k">:</span> <span class="pl-c1">List</span>&lt;<span class="pl-en">String</span>&gt;
        <span class="pl-c"><span class="pl-c">//</span> measureTimeMillis æ˜¯ kotlin é‡Œä¸€ä¸ªç»Ÿè®¡æ‰§è¡Œæ—¶é—´çš„æ–¹æ³•</span>
        <span class="pl-k">val</span> time <span class="pl-k">=</span> measureTimeMillis {
            <span class="pl-c"><span class="pl-c">//</span> é‡Œé¢ä¹Ÿç”¨ async å¹¶è¡Œè¯·æ±‚</span>
            <span class="pl-k">val</span> result1 <span class="pl-k">=</span> async { getPhotoInfo() } 
            <span class="pl-k">val</span> result2 <span class="pl-k">=</span> async { getPhotoLikeList() }
            <span class="pl-k">val</span> result3 <span class="pl-k">=</span> async { getPhotoCommentList() }
            results <span class="pl-k">=</span> <span class="pl-c1">listOf</span>(result1.await(), result2.await(), result3.await())
        }
        <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>Cost Time: <span class="pl-e">$time</span><span class="pl-pds">"</span></span>)
        results
    }
    
    <span class="pl-c1">println</span>(<span class="pl-s"><span class="pl-pds">"</span>å¼€å§‹å±•ç¤º UI: <span class="pl-e">${deferred.await()}</span><span class="pl-pds">"</span></span>)
}</pre></div>
<p>æ‰“å°ç»“æœï¼š</p>
<pre class="notranslate"><code class="notranslate">Cost Time: 1022
å¼€å§‹å±•ç¤º UI: [photo info, photo like list, photo comment list]
</code></pre>
<p>å¯ä»¥çœ‹åˆ°æ¶ˆè€—çš„æ—¶é—´å˜æˆ 1 ç§’ï¼Œå¤§å¤§æå‡äº†è¿è¡Œæ•ˆç‡ã€‚</p>
<p>æ‰€æœ‰å½“å¼‚æ­¥ä»»åŠ¡ä¹‹é—´æ²¡æœ‰äº’ç›¸ä¾èµ–æ—¶ï¼Œå¯ä»¥é€šè¿‡è¿™æ ·çš„ç»“æ„åŒ–å¹¶å‘æ¥ä¼˜åŒ–ä»£ç è¿è¡Œæ•ˆç‡ã€‚å®é™…ä¸Šï¼Œ<code class="notranslate">async</code> æœ€å¸¸è§çš„ä½¿ç”¨åœºæ™¯å°±æ˜¯ä¸æŒ‚èµ·å‡½æ•°ç»“åˆï¼Œä¼˜åŒ–å¹¶å‘ã€‚</p>
<h2>ç»“æŸäº†</h2>
<p>åˆ°è¿™æˆ‘ä»¬åº”è¯¥å·²ç»æ¸…æ¥šäº† <strong>Job</strong> æ˜¯ä»€ä¹ˆï¼Œèƒ½å¹²ä»€ä¹ˆç”¨äº†ã€‚ä¸»è¦å°±æ˜¯ã€Œ<strong>ç›‘æ§æ§åˆ¶åç¨‹è¿è¡Œ</strong>ã€å’Œå¤„ç†ã€Œ<strong>ç»“æ„åŒ–å¹¶å‘</strong>ã€ã€‚</p>
<p>æœ€åè¯´ä¸€ä¸‹ cancel çš„ä¸€ä¸ªå‘ï¼Œçœ‹ä¸‹é¢ä»£ç çŒœè¿è¡Œç»“æœï¼š</p>
<pre class="notranslate"><code class="notranslate">fun test12() = runBlocking {

    suspend fun fetchAll() {
        withContext(Dispatchers.IO) {
            var i = 0
            while (true) {
                i++
                logX("fetch i: $i")
            }
        }
    }

    val job = launch {
        logX("coroutine start!")
        fetchAll()
        logX("coroutine end!")
    }

    delay(500L)

    job.cancel()

    logX("Process end!")
}
</code></pre>
<p>è¿™æ®µä»£ç å…¶å®æ˜¯ä¸ä¼šç»“æŸçš„ï¼Œå› ä¸º fetchAll é‡Œæ²¡æœ‰å¤„ç†åç¨‹ cancel çš„æƒ…å†µï¼Œæ‰€æœ‰ä¼šä¸€ç›´è¿è¡Œã€‚å› ä¸º cancel åªæ˜¯æ”¹å˜äº†çŠ¶æ€ï¼Œå–æ¶ˆçš„è¯è¿˜éœ€è¦åç¨‹å†…éƒ¨å»é…åˆã€‚</p>
<p>ä¹‹å‰é‚£äº›ä¾‹å­èƒ½å–æ¶ˆï¼Œæ˜¯å› ä¸ºé‚£é‡Œé¢ç”¨äº† <code class="notranslate">delay</code> è¿™ä¸ªæ–¹æ³•ï¼Œæ˜¯ <code class="notranslate">delay</code> æ–¹æ³•é‡Œå¤„ç†äº† cancelï¼Œå¹¶æŠ›å‡ºäº†ä¸€ä¸ªå–æ¶ˆçš„å¼‚å¸¸ï¼Œæ‰€ä»¥åç¨‹æ‰èƒ½ç»“æŸã€‚</p>
<p>è§£å†³åŠæ³•å°±æ˜¯åœ¨åç¨‹é‡ŒåŠ ä¸Šå½“å‰çŠ¶æ€çš„åˆ¤æ–­ï¼š</p>
<div class="highlight highlight-source-kotlin"><pre class="notranslate"><span class="pl-k">fun</span> <span class="pl-en">test12</span>() <span class="pl-k">=</span> runBlocking {

    <span class="pl-k">suspend</span> <span class="pl-k">fun</span> <span class="pl-en">fetchAll</span>() {
        withContext(<span class="pl-en">Dispatchers</span>.<span class="pl-en">IO</span>) {
            <span class="pl-k">var</span> i <span class="pl-k">=</span> <span class="pl-c1">0</span>
            <span class="pl-k">while</span> (isActive) { <span class="pl-c"><span class="pl-c">//</span> å˜åŒ–åœ¨è¿™é‡Œ</span>
                i<span class="pl-k">++</span>
                logX(<span class="pl-s"><span class="pl-pds">"</span>fetch i: <span class="pl-e">$i</span><span class="pl-pds">"</span></span>)
            }
        }
    }

    <span class="pl-k">val</span> job <span class="pl-k">=</span> launch {
        logX(<span class="pl-s"><span class="pl-pds">"</span>coroutine start!<span class="pl-pds">"</span></span>)
        fetchAll()
        logX(<span class="pl-s"><span class="pl-pds">"</span>coroutine end!<span class="pl-pds">"</span></span>)
    }

    delay(<span class="pl-c1">500L</span>)

    job.cancel()

    logX(<span class="pl-s"><span class="pl-pds">"</span>Process end!<span class="pl-pds">"</span></span>)
}</pre></div>
<p>è¿™æ ·æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„æŒ‚èµ·å‡½æ•°ä¹Ÿèƒ½å“åº” cancel äº†ã€‚</p>
<hr>
<p>æœ€æœ€åå†æ¨èä¸€ä¸‹æå®¢æ—¶é—´çš„ã€ŠKotlin ç¼–ç¨‹ç¬¬ä¸€è¯¾ã€‹ï¼Œä¸Šé¢çš„å†…å®¹éƒ½æ˜¯å‚è€ƒçš„è¿™é—¨è¯¾ç¨‹ã€‚</p>
</div>
<div style="font-size:small;margin-top:8px;float:right;">â¤ï¸ è½¬è½½æ–‡ç« è¯·æ³¨æ˜å‡ºå¤„ï¼Œè°¢è°¢ï¼â¤ï¸</br></br><span>â¤ï¸ æ„Ÿè°¢ <span id="user-content-page_uv"></span> ä½å°ä¼™ä¼´çš„ <span id="user-content-page_pv"></span> æ¬¡è®¿é—®è¯¥æ–‡ç« ã€‚</span></br></br></div>
<button class="btn btn-block" type="button" onclick="openComments()" id="cmButton">è¯„è®º</button>
<div class="comments" id="comments"></div>
</div>
    <div id="footer">Copyright Â© <span id="year"></span><a href="https://blog.ian2018.club"> IAn2018cs </a>
<p>
<span id="runday"></span>Powered by <a href="https://meekdai.com/Gmeek.html" target="_blank">Gmeek</a>
</p>

<script>
if("08/31/2016"!=""){
    var now=new Date();
    var startSite=new Date("08/31/2016");
    var diff=now.getTime()-startSite.getTime();
    var diffDay=Math.floor(diff/(1000*60*60*24));
    document.getElementById("year").innerHTML=now.getFullYear();
    if(""!=""){document.getElementById("runday").innerHTML=" â€¢ "+"ç½‘ç«™è¿è¡Œ"+diffDay+"å¤©"+" â€¢ ";}
    else{document.getElementById("runday").innerHTML="ç½‘ç«™è¿è¡Œ"+diffDay+"å¤©"+" â€¢ ";}
}
</script>
</div>
</body>
<script>
var IconList={'sun': 'M8 10.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0V.75A.75.75 0 018 0zm0 13a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 018 13zM2.343 2.343a.75.75 0 011.061 0l1.06 1.061a.75.75 0 01-1.06 1.06l-1.06-1.06a.75.75 0 010-1.06zm9.193 9.193a.75.75 0 011.06 0l1.061 1.06a.75.75 0 01-1.06 1.061l-1.061-1.06a.75.75 0 010-1.061zM16 8a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5A.75.75 0 0116 8zM3 8a.75.75 0 01-.75.75H.75a.75.75 0 010-1.5h1.5A.75.75 0 013 8zm10.657-5.657a.75.75 0 010 1.061l-1.061 1.06a.75.75 0 11-1.06-1.06l1.06-1.06a.75.75 0 011.06 0zm-9.193 9.193a.75.75 0 010 1.06l-1.06 1.061a.75.75 0 11-1.061-1.06l1.06-1.061a.75.75 0 011.061 0z', 'moon': 'M9.598 1.591a.75.75 0 01.785-.175 7 7 0 11-8.967 8.967.75.75 0 01.961-.96 5.5 5.5 0 007.046-7.046.75.75 0 01.175-.786zm1.616 1.945a7 7 0 01-7.678 7.678 5.5 5.5 0 107.678-7.678z', 'sync': 'M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z', 'home': 'M6.906.664a1.749 1.749 0 0 1 2.187 0l5.25 4.2c.415.332.657.835.657 1.367v7.019A1.75 1.75 0 0 1 13.25 15h-3.5a.75.75 0 0 1-.75-.75V9H7v5.25a.75.75 0 0 1-.75.75h-3.5A1.75 1.75 0 0 1 1 13.25V6.23c0-.531.242-1.034.657-1.366l5.25-4.2Zm1.25 1.171a.25.25 0 0 0-.312 0l-5.25 4.2a.25.25 0 0 0-.094.196v7.019c0 .138.112.25.25.25H5.5V8.25a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 .75.75v5.25h2.75a.25.25 0 0 0 .25-.25V6.23a.25.25 0 0 0-.094-.195Z', 'github': 'M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z'};
var utterancesLoad=0;

let themeSettings={
    "dark": ["dark","moon","#00f0ff","dark-blue"],
    "light": ["light","sun","#ff5000","github-light"],
    "auto": ["auto","sync","","preferred-color-scheme"]
};
function changeTheme(mode, icon, color, utheme){
    document.documentElement.setAttribute("data-color-mode",mode);
    document.getElementById("themeSwitch").setAttribute("d",value=IconList[icon]);
    document.getElementById("themeSwitch").parentNode.style.color=color;
    if(utterancesLoad==1){utterancesTheme(utheme);}
}
function modeSwitch(){
    let currentMode=document.documentElement.getAttribute('data-color-mode');
    let newMode = currentMode === "light" ? "dark" : currentMode === "dark" ? "auto" : "light";
    localStorage.setItem("meek_theme", newMode);
    if(themeSettings[newMode]){
        changeTheme(...themeSettings[newMode]);
    }
}
function utterancesTheme(theme){
    const message={type:'set-theme',theme: theme};
    const iframe=document.getElementsByClassName('utterances-frame')[0];
    iframe.contentWindow.postMessage(message,'https://utteranc.es');
}
if(themeSettings[theme]){changeTheme(...themeSettings[theme]);}
console.log("\n %c Gmeek v2.19 https://github.com/Meekdai/Gmeek \n\n","padding:5px 0;background:#02d81d;color:#fff");
</script>

<script>
document.getElementById("pathHome").setAttribute("d",IconList["home"]);
document.getElementById("pathIssue").setAttribute("d",IconList["github"]);

function openComments(){
    cm=document.getElementById("comments");
    cmButton=document.getElementById("cmButton");
    cmButton.innerHTML="loading";
    span=document.createElement("span");
    span.setAttribute("class","AnimatedEllipsis");
    cmButton.appendChild(span);

    script=document.createElement("script");
    script.setAttribute("src","https://utteranc.es/client.js");
    script.setAttribute("repo","chenshuais/chenshuais.github.io");
    script.setAttribute("issue-term","title");
    
    if(localStorage.getItem("meek_theme")=="dark"){script.setAttribute("theme","dark-blue");}
    else if(localStorage.getItem("meek_theme")=="light") {script.setAttribute("theme","github-light");}
    else{script.setAttribute("theme","preferred-color-scheme");}
    
    script.setAttribute("crossorigin","anonymous");
    script.setAttribute("async","");
    cm.appendChild(script);

    int=self.setInterval("iFrameLoading()",200);
}

function iFrameLoading(){
    var utterances=document.getElementsByClassName('utterances');
    if(utterances.length==1){
        if(utterances[0].style.height!=""){
            utterancesLoad=1;
            int=window.clearInterval(int);
            document.getElementById("cmButton").style.display="none";
            console.log("utterances Load OK");
        }
    }
}
</script>
<script async src='//blog-image.ian2018.cn/webviso.min.js' data-page-pv-id='user-content-page_pv' data-page-uv-id='user-content-page_uv'></script>

</html>
